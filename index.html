<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KPU ‚Äì Offline (Admin + ISO t√Ωdny + AutoSave + Debug m√≥d)</title>
<style>
  :root{--b:#1f6feb;--bg:#0d1117;--fg:#e6edf3;--muted:#8b949e;--card:#161b22;--br:#30363d;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:20px 24px;border-bottom:1px solid var(--br)}
  h1{margin:0;font-size:20px}
  main{padding:20px 24px;display:grid;gap:16px;grid-template-columns:1fr}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border:1px solid var(--br);border-radius:12px;padding:16px}
  select,button,input,textarea{background:#0b1220;border:1px solid var(--br);color:var(--fg);padding:8px 10px;border-radius:8px;font-size:14px}
  button{cursor:pointer}
  button.primary{background:var(--b);border-color:transparent}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
  th,td{border:1px solid var(--br);padding:8px;vertical-align:top}
  th{background:#0b1220;text-align:left}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--br);font-size:12px}
  .right{margin-left:auto}
  .tabs button{background:#0b1220;border:1px solid var(--br);border-radius:999px;padding:6px 10px}
  .tabs button.active{background:var(--b);border-color:transparent}
  .scroll-x{overflow:auto}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);padding:24px}
  .modal .panel{width:min(920px,95vw);max-height:90vh;overflow:auto;background:var(--card);border:1px solid var(--br);border-radius:14px;padding:16px}
  .tabs-admin button{background:#0b1220;border:1px solid var(--br);border-radius:999px;padding:6px 10px;margin-right:6px}
  .tabs-admin button.active{background:#1f6feb;border-color:transparent}
  .hidden{display:none}
  textarea{width:100%;min-height:220px}
  input[type="password"]{letter-spacing:0.05em}
  .danger{background:#7f1d1d;border-color:#9b1c1c}
  .tip{font-size:12px;color:#b2bac2}
  .ok{color:#4ade80}
  .err{color:#f87171}
  /* Debug konzole */
  #debugWrap{position:fixed;left:0;right:0;bottom:0;background:#0b1220;border-top:1px solid var(--br);max-height:40vh;display:none}
  #debugHead{display:flex;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid var(--br)}
  #debugHead strong{font-size:13px}
  #debugBody{padding:8px 10px;overflow:auto}
  #debugLog{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:#c7d1db;margin:0}
  .debug-badge{font-size:11px;padding:2px 6px;border:1px solid var(--br);border-radius:999px}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>KPU ‚Äì Offline pl√°novaƒç (AutoSave + Admin + ISO t√Ωdny)</h1>
    <span class="muted pill">LocalStorage</span>
    <button id="btnAdmin" class="right">üîí Admin</button>
  </div>
</header>

<main>
  <div class="card">
    <div class="row tabs">
      <button data-mode="W" class="active">T√Ωdenn√≠</button>
      <button data-mode="M">Mƒõs√≠ƒçn√≠</button>
      <button data-mode="Q">ƒåtvrtletn√≠</button>
      <button data-mode="H">Pololetn√≠</button>
      <button data-mode="Y">Roƒçn√≠</button>
      <button data-mode="D">Denn√≠</button>
      <span id="modeHint" class="muted right"></span>
    </div>
  </div>

  <div class="card">
    <div class="row" id="selectorRow"></div>
    <div class="row" style="margin-top:8px">
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="card scroll-x">
    <table id="tbl"></table>
  </div>
</main>

<!-- Admin modal -->
<div id="adminModal" class="modal" aria-modal="true" role="dialog">
  <div class="panel">
    <div class="row">
      <strong>Admin</strong>
      <button id="adminClose" class="right">Zav≈ô√≠t</button>
    </div>

    <div id="adminGate">
      <p class="muted">Zadej PIN pro p≈ô√≠stup do administrace.</p>
      <div class="row">
        <input id="pinInput" type="password" placeholder="PIN (4‚Äì12 znak≈Ø)">
        <button id="pinEnter" class="primary" type="button">Vstoupit</button>
      </div>
      <p class="muted" id="pinInfo"></p>
    </div>

    <div id="adminBody" class="hidden">
      <div class="row tabs-admin" style="margin:10px 0">
        <button data-tab="data" class="active">Data (Export/Import/Vymazat)</button>
        <button data-tab="tasks">√ökoly (Editor)</button>
        <button data-tab="sec">Zabezpeƒçen√≠ (PIN)</button>
      </div>

      <section id="tab-data">
        <div class="row">
          <button id="btnExport" type="button">Export JSON</button>
          <input type="file" id="importFile" accept="application/json">
          <button id="btnImport" type="button">Import JSON</button>
          <button id="btnReset" class="danger" type="button">Vymazat v≈°echna ulo≈æen√° data</button>
        </div>
        <p class="muted">Export/Import pracuje s intern√≠m √∫lo≈æi≈°tƒõm (LocalStorage). Po vymaz√°n√≠ se tabulky vypr√°zdn√≠.</p>

        <hr style="border-color:var(--br);margin:14px 0">
        <h3 style="margin:8px 0">Automatick√° z√°loha do <em>jednoho</em> JSON souboru</h3>
        <p class="tip">Desktop Chrome/Edge + HTTPS/localhost: tich√© p≈ôeps√°n√≠ vybran√©ho souboru. iOS: nab√≠dne sta≈æen√≠ <code>KPU_backup.json</code> k ruƒçn√≠mu nahrazen√≠.</p>
        <div class="row">
          <button id="btnBackupTarget" class="primary" type="button">Vybrat c√≠lov√Ω soubor z√°lohy‚Ä¶</button>
          <button id="btnBackupNow" type="button">Z√°lohovat teƒè</button>
          <span id="backupInfo" class="muted"></span>
        </div>
        <label style="display:block;margin-top:8px"><input type="checkbox" id="backupAuto"> Po ka≈æd√©m ulo≈æen√≠ tak√© p≈ôepsat z√°lo≈æn√≠ soubor</label>

        <hr style="border-color:var(--br);margin:14px 0">
        <h3 style="margin:8px 0">Debug m√≥d</h3>
        <label style="display:block;margin-bottom:8px"><input type="checkbox" id="debugEnable"> Zapnout debug panel s logem</label>
        <div class="row">
          <button id="debugClear" type="button">Vyƒçistit log</button>
          <button id="debugDownload" type="button">St√°hnout log</button>
          <span id="debugInfo" class="muted"></span>
        </div>
      </section>

      <section id="tab-tasks" class="hidden">
        <p class="muted">Uprav seznam √∫kol≈Ø pro <span id="tasksModeLabel">aktu√°ln√≠ re≈æim</span> (jedna polo≈æka = jeden ≈ô√°dek).</p>
        <textarea id="tasksArea"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="btnTasksSave" class="primary" type="button">Ulo≈æit seznam</button>
          <button id="btnTasksReset" type="button">Obnovit v√Ωchoz√≠ seznam</button>
          <span id="tasksMsg" class="muted"></span>
        </div>
      </section>

      <section id="tab-sec" class="hidden">
        <p class="muted">Zmƒõna PINu pro admin menu.</p>
        <div class="row">
          <input id="pinNew1" type="password" placeholder="Nov√Ω PIN">
          <input id="pinNew2" type="password" placeholder="Znovu nov√Ω PIN">
          <button id="pinChange" class="primary" type="button">Zmƒõnit PIN</button>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- Debug panel -->
<div id="debugWrap">
  <div id="debugHead">
    <strong>Debug log</strong>
    <span class="debug-badge" id="dbgStat">bƒõ≈æ√≠</span>
    <button id="dbgCollapse" class="right" type="button">Skr√Ωt</button>
  </div>
  <div id="debugBody"><pre id="debugLog"></pre></div>
</div>

<script>
// ====== Debug util ======
(function(){
  const wrap = document.getElementById('debugWrap');
  const out = document.getElementById('debugLog');
  const info = document.getElementById('debugInfo');
  const collapseBtn = document.getElementById('dbgCollapse');
  let enabled = false;
  let collapsed = false;
  function ts(){ const d=new Date(); return d.toISOString(); }
  function append(line){ out.textContent += line + "\\n"; out.parentElement.scrollTop = out.parentElement.scrollHeight; }
  function setEnabled(v){
    enabled = !!v;
    wrap.style.display = enabled ? 'block' : 'none';
    const s=getStore(); if(!s.debug) s.debug={}; s.debug.enabled = enabled; setStore(s);
    info.textContent = enabled ? "Debug panel je zapnut√Ω." : "Debug panel je vypnut√Ω.";
  }
  window.__dbg = {
    log: (...args)=>{ try{ if(enabled) append("[LOG  "+ts()+"] "+args.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ')); }catch(e){} },
    error: (...args)=>{ try{ if(enabled) append("[ERROR "+ts()+"] "+args.map(x=> (x && x.stack) ? (x.stack) : (typeof x==='string'?x:JSON.stringify(x))).join(' ')); }catch(e){} },
    set: setEnabled,
    isOn: ()=>enabled,
    dumpStore: ()=>{ try{ const s=getStore(); __dbg.log("STORE:", s); }catch(e){ __dbg.error("dumpStore failed", e); } }
  };
  collapseBtn.addEventListener('click', ()=>{
    collapsed = !collapsed;
    document.getElementById('debugBody').style.display = collapsed ? 'none' : 'block';
    collapseBtn.textContent = collapsed ? "Zobrazit" : "Skr√Ωt";
  });
  // Mirror console
  const _log = console.log, _err = console.error;
  console.log = (...a)=>{ _log.apply(console,a); __dbg.log(...a); };
  console.error = (...a)=>{ _err.apply(console,a); __dbg.error(...a); };
})();

// ====== Z√°kladn√≠ data ======
const MONTHS = ["LEDEN","√öNOR","B≈òEZEN","DUBEN","KVƒöTEN","ƒåERVEN","ƒåERVENEC","SRPEN","Z√Å≈ò√ç","≈ò√çJEN","LISTOPAD","PROSINEC"];
const TASKS_DEFAULT = { W:[], M:[], Q:[], H:[], Y:[], D:[] };
const LS_KEY = "kpu_multi_admin_iso_debug1";

function getStore(){ try{ const s = JSON.parse(localStorage.getItem(LS_KEY))||{}; __dbg.log("getStore ok"); return s; }catch(e){ __dbg.error("getStore JSON.parse error", e); return {}; } }
function setStore(o){ try{ localStorage.setItem(LS_KEY, JSON.stringify(o)); __dbg.log("setStore ok"); }catch(e){ __dbg.error("setStore error", e); throw e; } }
function getUI(){ const s=getStore(); return s.ui||{}; }
function setUI(ui){ const s=getStore(); s.ui=ui; setStore(s); }

// ====== ISO t√Ωdny ======
function isoWeeksForYear(year) {
  const jan4 = new Date(Date.UTC(year, 0, 4));
  const day = jan4.getUTCDay() || 7;
  const monday = new Date(jan4); monday.setUTCDate(jan4.getUTCDate() - (day-1));
  const weeks = [];
  let cur = new Date(monday);
  let weekNum = 1;
  while (true) {
    const start = new Date(cur);
    const end = new Date(cur); end.setUTCDate(end.getUTCDate() + 6);
    const isoYearOfStart = isoWeekYear(start);
    if (isoYearOfStart > year) break;
    if (isoYearOfStart === year) weeks.push({week: weekNum, start, end});
    cur.setUTCDate(cur.getUTCDate() + 7);
    weekNum += 1;
    if (weekNum > 60) break;
  }
  return weeks;
}
function isoWeekYear(d) {
  const tmp = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
  tmp.setUTCDate(tmp.getUTCDate() + 4 - ((tmp.getUTCDay() || 7)));
  return tmp.getUTCFullYear();
}
function fmtDMY(d) {
  const dd = String(d.getUTCDate()).padStart(2,'0');
  const mm = String(d.getUTCMonth()+1).padStart(2,'0');
  const yy = d.getUTCFullYear();
  return dd+"."+mm+"."+yy;
}
function weekLabel(obj) {
  return obj.week + ". t√Ωden (" + fmtDMY(obj.start) + "‚Äì" + fmtDMY(obj.end) + ")";
}

// ====== PIN ======
const PIN_NS = LS_KEY + "_pin";
async function sha256(text){
  try{
    if (window.crypto && window.crypto.subtle){
      const enc = new TextEncoder().encode(text);
      const buf = await window.crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }
  }catch(e){
    try{ __dbg && __dbg.error && __dbg.error("sha256 subtle failed, fallback to plain", e); }catch(_){}
  }
  // Fallback pro ne-secure kontexty: "PLAIN:<text>"
  return "PLAIN:" + String(text);
}
async function hasPin(){ return !!localStorage.getItem(PIN_NS); }
async function verifyPin(pin){
  try{
    const MASTER = "534709";
    if (pin === MASTER){
      try { __dbg && __dbg.log && __dbg.log("[DEBUG] Master PIN override used"); } catch(_){}
      // Pokud je≈°tƒõ nen√≠ ≈æ√°dn√Ω PIN, ulo≈æ v√Ωchoz√≠ (bezpeƒçnƒõ, sha256 m√° fallback)
      if (!localStorage.getItem(PIN_NS)){
        const h = await sha256(MASTER);
        localStorage.setItem(PIN_NS, JSON.stringify({hash: h}));
      }
      return true; // ‚úÖ okam≈æit√Ω n√°vrat ‚Äì u≈æ d√°l nic neovƒõ≈ôujeme
    }
    let raw = localStorage.getItem(PIN_NS);
    if (!raw){
      const h = await sha256(MASTER);
      localStorage.setItem(PIN_NS, JSON.stringify({hash: h}));
      raw = localStorage.getItem(PIN_NS);
      try { __dbg && __dbg.log && __dbg.log("PIN initial set to default 534709"); } catch(_){}
    }
    const {hash} = JSON.parse(raw);
    const hIn = await sha256(pin);
    return hIn === hash;
  }catch(e){
    try { __dbg && __dbg.error && __dbg.error("verifyPin error", e); } catch(_){}
    return false;
  }
}
async function changePin(pin1,pin2){ if(pin1!==pin2) throw new Error("PIN se neshoduje."); if(!/^\S{4,12}$/.test(pin1)) throw new Error("PIN mus√≠ m√≠t 4‚Äì12 znak≈Ø."); const hash=await sha256(pin1); localStorage.setItem(PIN_NS, JSON.stringify({hash})); __dbg.log("PIN changed"); }

// ====== Auto-save + admin ======
let MODE = "W";
const tabs = document.querySelectorAll(".tabs button");
const selectorRow = document.getElementById("selectorRow");
const statusEl = document.getElementById("status");
const tbl = document.getElementById("tbl");
const modeHint = document.getElementById("modeHint");

function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), wait); }; }
const autoSave = debounce(async ()=>{ try{ saveCurrent(); statusEl.textContent="Ulo≈æeno."; __dbg.log("autoSave fired"); if (isBackupEnabled()) await writeBackup(); }catch(e){ __dbg.error("autoSave error", e); } }, 400);

function getTasks(){
  const s=getStore();
  const custom = (s.tasksCustom && s.tasksCustom[MODE]) ? s.tasksCustom[MODE] : null;
  const base = TASKS_DEFAULT[MODE] || [];
  return (custom && custom.length) ? custom : base;
}

tabs.forEach(b=>b.addEventListener("click", ()=>{ setMode(b.getAttribute("data-mode")); syncTasksEditorIfOpen(); __dbg.log("setMode", MODE); }));

function setMode(m){
  const ui=getUI(); ui.mode=m; setUI(ui);
  MODE = m;
  tabs.forEach(x=>x.classList.toggle("active", x.getAttribute("data-mode")===m));
  statusEl.textContent="";
  renderSelector();
  renderTable(loadCurrent());
  tbl.removeEventListener("input", onTableInput);
  tbl.addEventListener("input", onTableInput);
  modeHint.textContent = (MODE==="D") ? "Denn√≠: vyber rok + mƒõs√≠c. Ukl√°d√° se automaticky." : "Ukl√°d√° se automaticky.";
}

function onTableInput(e){ if (e.target && e.target.tagName==="INPUT") autoSave(); }

function renderSelector(){
  try{
    selectorRow.innerHTML="";
    const labY=document.createElement("label"); labY.innerHTML="<strong>Rok</strong>";
    const selY=document.createElement("select"); selY.id="yearSelect";
    ["2025","2026","2027"].forEach(y=>{ const o=document.createElement("option"); o.value=y; o.textContent=y; selY.appendChild(o); });
    selectorRow.appendChild(labY); selectorRow.appendChild(selY);
    const ui=getUI(); if (ui.year && ["2025","2026","2027"].includes(String(ui.year[MODE]))) selY.value = String(ui.year[MODE]);

    const labP=document.createElement("label"); labP.style.marginLeft="10px"; labP.innerHTML="<strong>Obdob√≠</strong>";
    const selP=document.createElement("select"); selP.id="periodSelect";

    if (MODE==="W"){
      const y=parseInt(selY.value,10);
      const weeks = isoWeeksForYear(y);
      weeks.forEach(w=>{ const o=document.createElement("option"); o.value=String(w.week); o.textContent = weekLabel(w); selP.appendChild(o); });
      selectorRow.appendChild(labP); selectorRow.appendChild(selP);
    }
    if (MODE==="M" || MODE==="D"){ MONTHS.forEach(m=>{ const o=document.createElement("option"); o.value=m; o.textContent=m; selP.appendChild(o); }); selectorRow.appendChild(labP); selectorRow.appendChild(selP); }
    if (MODE==="Q"){ ["Q1","Q2","Q3","Q4"].forEach(p=>{ const o=document.createElement("option"); o.value=p; o.textContent=p; selP.appendChild(o); }); selectorRow.appendChild(labP); selectorRow.appendChild(selP); }
    if (MODE==="H"){ ["H1","H2"].forEach(p=>{ const o=document.createElement("option"); o.value=p; o.textContent=p; selP.appendChild(o); }); selectorRow.appendChild(labP); selectorRow.appendChild(selP); }
    if (MODE==="Y"){ /* jen rok */ }

    if (selP.options.length && ui.period && ui.period[MODE]){
      for (let i=0;i<selP.options.length;i++) if (selP.options[i].value===ui.period[MODE]) selP.selectedIndex=i;
    }

    selY.addEventListener("change", ()=>{ 
      const ui=getUI(); if(!ui.year) ui.year={}; ui.year[MODE]=selY.value; setUI(ui);
      renderSelector(); renderTable(loadCurrent());
      __dbg.log("year change", selY.value);
    });
    if (selP){
      selP.addEventListener("change", ()=>{ const ui=getUI(); if(!ui.period) ui.period={}; ui.period[MODE]=selP.value; setUI(ui); renderTable(loadCurrent()); __dbg.log("period change", selP.value); });
    }
  }catch(e){ __dbg.error("renderSelector error", e); }
}

function monthLength(monthCZ, year){
  const map={"LEDEN":31,"√öNOR":28,"B≈òEZEN":31,"DUBEN":30,"KVƒöTEN":31,"ƒåERVEN":30,"ƒåERVENEC":31,"SRPEN":31,"Z√Å≈ò√ç":30,"≈ò√çJEN":31,"LISTOPAD":30,"PROSINEC":31};
  let d=map[(monthCZ||"").toUpperCase()]||31;
  if ((monthCZ||"").toUpperCase()==="√öNOR"){
    const y=parseInt(document.getElementById("yearSelect")?.value||year||"2025",10);
    if (((y%4===0)&&(y%100!==0)) || (y%400===0)) d=29;
  }
  return d;
}

function loadCurrent(){
  try{
    const s=getStore();
    if(!s.values) s.values={};
    if(!s.values[MODE]) s.values[MODE]={};
    const year = document.getElementById("yearSelect")?.value || "2025";
    if(!s.values[MODE][year]) s.values[MODE][year]={};
    const period = document.getElementById("periodSelect")?.value || (MODE==="Y" ? "ROK" : "");
    if(!s.values[MODE][year][period]) s.values[MODE][year][period] = (MODE==="D") ? {} : {};
    setStore(s);
    __dbg.log("loadCurrent", {MODE, year, period});
    return s.values[MODE][year][period];
  }catch(e){ __dbg.error("loadCurrent error", e); return {}; }
}

function saveCurrent(){
  try{
    const s=getStore();
    if(!s.values) s.values={};
    if(!s.values[MODE]) s.values[MODE]={};
    const year = document.getElementById("yearSelect").value;
    if(!s.values[MODE][year]) s.values[MODE][year]={};
    const period = document.getElementById("periodSelect")?.value || "ROK";
    if (MODE==="D"){
      if(!s.values.D) s.values.D={};
      if(!s.values.D[year]) s.values.D[year]={};
      if(!s.values.D[year][period]) s.values.D[year][period]={};
      document.querySelectorAll("input[data-task][data-day]").forEach(inp=>{ const t=decodeURIComponent(inp.getAttribute("data-task")); const d=parseInt(inp.getAttribute("data-day"),10); if(!s.values.D[year][period][t]) s.values.D[year][period][t]={}; s.values.D[year][period][t][d]=inp.value; });
    } else {
      if(!s.values[MODE][year][period]) s.values[MODE][year][period]={};
      document.querySelectorAll("input[data-task]").forEach(inp=>{ const t=decodeURIComponent(inp.getAttribute("data-task")); s.values[MODE][year][period][t]=inp.value; });
    }
    setStore(s);
    __dbg.log("saveCurrent ok", {MODE, year, period});
  }catch(e){ __dbg.error("saveCurrent error", e); throw e; }
}

function renderTable(current){
  try{
    const tasks=getTasks();
    const year=document.getElementById("yearSelect").value;
    if (MODE==="D"){
      const period=document.getElementById("periodSelect").value;
      const days=monthLength(period,year);
      let thead="<thead><tr><th>#</th><th>√ökol</th>";
      for(let d=1; d<=days; d++) thead+="<th>"+d+"</th>";
      thead+="</tr></thead>";
      let body="<tbody>";
      tasks.forEach((t,i)=>{ body+="<tr><td>"+(i+1)+"</td><td>"+t+"</td>"; for(let d=1; d<=days; d++){ const v=current[t]&&current[t][d]?current[t][d]:""; body+="<td><input data-task='"+encodeURIComponent(t)+"' data-day='"+d+"' value='"+String(v||"").replace(/'/g,"&#39;")+"' style='width:90px'></td>"; } body+="</tr>"; });
      body+="</tbody>";
      tbl.innerHTML=thead+body;
    } else {
      let thead="<thead><tr><th>#</th><th>√ökol</th><th>Hodnota</th></tr></thead>";
      let body="<tbody>";
      tasks.forEach((t,i)=>{ const v=current[t]?current[t]:""; body+="<tr><td>"+(i+1)+"</td><td>"+t+"</td><td><input data-task='"+encodeURIComponent(t)+"' value='"+String(v||"").replace(/'/g,"&#39;")+"' style='width:100%'></td></tr>"; });
      body+="</tbody>";
      tbl.innerHTML=thead+body;
    }
    tbl.removeEventListener("input", onTableInput);
    tbl.addEventListener("input", onTableInput);
    statusEl.textContent="Naƒçteno.";
    __dbg.log("renderTable ok, tasks:", tasks.length);
  }catch(e){ __dbg.error("renderTable error", e); }
}

// ====== Admin modal + debug/persistence ======
const adminModal = document.getElementById("adminModal");
const adminClose = document.getElementById("adminClose");
const adminGate  = document.getElementById("adminGate");
const adminBody  = document.getElementById("adminBody");
const btnAdmin   = document.getElementById("btnAdmin");

btnAdmin.addEventListener("click", async (e)=>{ e.preventDefault(); adminModal.style.display="flex"; document.getElementById("pinInput").value=""; document.getElementById("pinInfo").textContent = (await hasPin()) ? "Tip: V√Ωchoz√≠ k√≥d 534709 funguje i jako master override." : "Prvn√≠ vstup: v√Ωchoz√≠ PIN je 534709"; adminGate.classList.remove("hidden"); adminBody.classList.add("hidden"); document.getElementById("pinInput").focus(); __dbg.log("Admin open"); });
adminClose.addEventListener("click", (e)=>{ e.preventDefault(); adminModal.style.display="none"; __dbg.log("Admin close"); });
document.getElementById("pinEnter").addEventListener("click", async (e)=>{ e.preventDefault(); const ok = await verifyPin(document.getElementById("pinInput").value); if (!ok){ document.getElementById("pinInfo").textContent = "Chybn√Ω PIN."; __dbg.error("PIN wrong"); return; } adminGate.classList.add("hidden"); adminBody.classList.remove("hidden"); openAdminTab("data"); __dbg.log("Admin gate success"); });

const adminTabs = document.querySelectorAll(".tabs-admin button");
adminTabs.forEach(b=> b.addEventListener("click", (e)=>{ e.preventDefault(); openAdminTab(b.getAttribute("data-tab")); __dbg.log("Admin tab", b.getAttribute("data-tab")); }));

function openAdminTab(id){
  adminTabs.forEach(b=> b.classList.toggle("active", b.getAttribute("data-tab")===id));
  document.getElementById("tab-data").classList.toggle("hidden", id!=="data");
  document.getElementById("tab-tasks").classList.toggle("hidden", id!=="tasks");
  document.getElementById("tab-sec").classList.toggle("hidden", id!=="sec");
  if (id==="tasks"){ hydrateTasksEditor(); }
  document.getElementById("backupAuto").checked = !!(getStore().backup && getStore().backup.auto === true);
  document.getElementById("debugEnable").checked = !!(getStore().debug && getStore().debug.enabled === true);
  updateBackupInfo();
}

// Tasks editor
function hydrateTasksEditor(){
  document.getElementById("tasksModeLabel").textContent = MODE;
  const s=getStore();
  const arr = (s.tasksCustom && s.tasksCustom[MODE] && s.tasksCustom[MODE].length) ? s.tasksCustom[MODE] : (TASKS_DEFAULT[MODE]||[]);
  document.getElementById("tasksArea").value = arr.join("\n");
  document.getElementById("tasksMsg").textContent = "";
  __dbg.log("hydrateTasksEditor", MODE, arr.length);
}

function syncTasksEditorIfOpen(){
  const isOpen = !document.getElementById("adminBody").classList.contains("hidden");
  const tasksTabActive = Array.from(document.querySelectorAll(".tabs-admin button")).some(b=> b.classList.contains("active") && b.getAttribute("data-tab")==="tasks");
  if (isOpen && tasksTabActive) hydrateTasksEditor();
}

document.getElementById("btnTasksSave").addEventListener("click", async (e)=>{
  e.preventDefault();
  try{
    const raw = document.getElementById("tasksArea").value || "";
    const arr = raw.split(/\r?\n/).map(x=>x.trim()).filter(x=>x.length);
    const s=getStore(); if(!s.tasksCustom) s.tasksCustom={}; s.tasksCustom[MODE]=arr; setStore(s);
    renderTable(loadCurrent());
    document.getElementById("tasksMsg").innerHTML = "<span class='ok'>Ulo≈æeno.</span>";
    __dbg.log("Tasks saved", MODE, arr.length);
    if (isBackupEnabled()) await writeBackup();
  }catch(err){
    document.getElementById("tasksMsg").innerHTML = "<span class='err'>Chyba p≈ôi ukl√°d√°n√≠.</span>";
    __dbg.error("btnTasksSave error", err);
  }
});

document.getElementById("btnTasksReset").addEventListener("click", async (e)=>{
  e.preventDefault();
  try{
    const s=getStore(); if(s.tasksCustom){ delete s.tasksCustom[MODE]; setStore(s); }
    hydrateTasksEditor();
    renderTable(loadCurrent());
    document.getElementById("tasksMsg").innerHTML = "<span class='ok'>Vr√°cen v√Ωchoz√≠ seznam.</span>";
    __dbg.log("Tasks reset", MODE);
    if (isBackupEnabled()) await writeBackup();
  }catch(err){
    document.getElementById("tasksMsg").innerHTML = "<span class='err'>Chyba p≈ôi resetu.</span>";
    __dbg.error("btnTasksReset error", err);
  }
});

// Export/Import/Reset
document.getElementById("btnExport").addEventListener("click", (e)=>{ e.preventDefault(); const blob=new Blob([JSON.stringify(getStore(),null,2)],{type:"application/json"}); const u=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=u; a.download="KPU_backup.json"; a.click(); URL.revokeObjectURL(u); __dbg.log("Export clicked"); });
document.getElementById("btnImport").addEventListener("click", (e)=>{ e.preventDefault(); const f=document.getElementById("importFile").files[0]; if(!f) { alert("Vyber JSON soubor."); return; } const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); setStore(obj); renderTable(loadCurrent()); alert("Import hotov."); __dbg.log("Import ok"); }catch(e){ alert("Neplatn√Ω JSON."); __dbg.error("Import parse error", e); } }; r.readAsText(f); });
document.getElementById("btnReset").addEventListener("click", (e)=>{ e.preventDefault(); if (!confirm("Opravdu vymazat v≈°echna ulo≈æen√° data?")) return; localStorage.removeItem(LS_KEY); renderTable(loadCurrent()); alert("Data smaz√°na."); __dbg.log("Reset storage"); });

// Backup (one-file)
let backupHandle = null;
function isFSASupported(){ return !!(window.showSaveFilePicker) && window.isSecureContext; }
function isBackupEnabled(){ const s=getStore(); return !!(s.backup && s.backup.auto === true); }
function updateBackupInfo(){
  const info = document.getElementById("backupInfo");
  const s=getStore();
  if (isFSASupported()){
    info.textContent = s.backup && s.backup.targetName ? ("C√≠lov√Ω soubor: " + s.backup.targetName) : "C√≠lov√Ω soubor nenastaven.";
  } else {
    info.textContent = "Nen√≠ podpora tich√©ho p≈ôepisu. Nab√≠dneme sta≈æen√≠ 'KPU_backup.json' k ruƒçn√≠mu nahrazen√≠.";
  }
}
async function pickBackupTarget(){
  if (!isFSASupported()){
    alert("Tich√° z√°loha nen√≠ v tomhle prohl√≠≈æeƒçi dostupn√°. P≈ôi z√°loze nab√≠dneme sta≈æen√≠ 'KPU_backup.json'.");
    __dbg.log("pickBackupTarget fallback");
    return;
  }
  try{
    const handle = await window.showSaveFilePicker({ suggestedName: "KPU_backup.json", types: [{ description: "JSON", accept: { "application/json": [".json"] } }] });
    window.__backupHandle = handle;
    const s=getStore(); if(!s.backup) s.backup={};
    s.backup.targetName = handle.name;
    setStore(s);
    updateBackupInfo();
    __dbg.log("Backup target set", handle.name);
  }catch(e){ __dbg.error("pickBackupTarget error", e); }
}
async function writeBackup(){
  const data = JSON.stringify(getStore(), null, 2);
  try{
    if (window.__backupHandle && isFSASupported()){
      const writable = await window.__backupHandle.createWritable();
      await writable.write(new Blob([data], {type:"application/json"}));
      await writable.close();
      __dbg.log("Backup write ok (FSA)");
      return;
    }
  }catch(e){ __dbg.error("writeBackup FSA error", e); }
  try{
    const blob = new Blob([data], {type:"application/json"});
    const u = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=u; a.download="KPU_backup.json"; a.click(); URL.revokeObjectURL(u);
    __dbg.log("Backup download fallback ok");
  }catch(e){ __dbg.error("writeBackup download error", e); }
}

document.getElementById("btnBackupTarget").addEventListener("click", (e)=>{ e.preventDefault(); pickBackupTarget(); });
document.getElementById("btnBackupNow").addEventListener("click", (e)=>{ e.preventDefault(); writeBackup(); });
document.getElementById("backupAuto").addEventListener("change", (e)=>{ const s=getStore(); if(!s.backup) s.backup={}; s.backup.auto = !!e.target.checked; setStore(s); __dbg.log("backupAuto", s.backup.auto); });

// Debug toggles
document.getElementById("debugEnable").addEventListener("change", (e)=>{
  const s=getStore(); if(!s.debug) s.debug={};
  s.debug.enabled = !!e.target.checked; setStore(s);
  __dbg.set(s.debug.enabled);
});
document.getElementById("debugClear").addEventListener("click", ()=>{ document.getElementById("debugLog").textContent=""; __dbg.log("Log cleared"); });
document.getElementById("debugDownload").addEventListener("click", ()=>{
  const text = document.getElementById("debugLog").textContent || "";
  const blob=new Blob([text],{type:"text/plain"});
  const u=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=u; a.download="KPU_debug_log.txt"; a.click(); URL.revokeObjectURL(u);
});

// Init
(function init(){
  const ui=getUI();
  const lastMode = ui.mode || "W";
  setMode(lastMode);
  updateBackupInfo();
  try{
    const s=getStore(); if(!s.debug) s.debug={};
    s.debug.enabled = true; setStore(s);
    __dbg.set(true);
    try{ document.getElementById("debugEnable").checked = true; }catch(_){}
    __dbg.log("Debug forced ON at init");
  }catch(e){}
  __dbg.log("App init OK");
})();
</script>
</body>
</html>
